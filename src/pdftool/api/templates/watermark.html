{% extends "base.html" %}

{% block title %}æ·»åŠ æ°´å° - PDFTool{% endblock %}

{% block header_icon %}ğŸ³{% endblock %}
{% block header_title %}æ·»åŠ æ°´å°{% endblock %}
{% block header_description %}ä¸Šä¼ å›¾ç‰‡/è¾“å…¥æ–‡å­—ä»¥åœ¨PDFä¸­æ·»åŠ æ°´å°{% endblock %}

{% set show_back_button = true %}
{% block content %}
<div class="upload-area" id="watermarkDropZone">
    <h3>é€‰æ‹©è¦æ·»åŠ æ°´å°çš„PDFæ–‡ä»¶</h3>
    <input type="file" id="pdfFile" accept=".pdf">

    <div class="options-group">
        <h4>æ°´å°ç±»å‹ï¼š</h4>
        <label>
            <input type="radio" name="watermarkType" value="text" checked> æ–‡å­—æ°´å°
        </label>
        <label>
            <input type="radio" name="watermarkType" value="image"> å›¾ç‰‡æ°´å°
        </label>
    </div>

    <!-- æ–‡å­—æ°´å°é€‰é¡¹ -->
    <div class="options-group" id="textWatermarkOptions">
        <h4>æ–‡å­—æ°´å°è®¾ç½®ï¼š</h4>
        <div style="margin-bottom: 15px;">
            <label for="watermarkText">æ°´å°æ–‡å­—ï¼š</label>
            <input type="text" id="watermarkText" placeholder="è¯·è¾“å…¥æ°´å°æ–‡å­—" style="width: 300px; margin-left: 10px;">
        </div>
        <div style="margin-bottom: 15px;">
            <label for="fontSize">å­—ä½“å¤§å°ï¼š</label>
            <input type="number" id="fontSize" value="36" min="12" max="100" style="width: 80px; margin-left: 10px;">
            <span style="margin-left: 5px; color: #6c757d;">px</span>
        </div>
        <div style="margin-bottom: 15px;">
            <label for="fontColor">å­—ä½“é¢œè‰²ï¼š</label>
            <input type="color" id="fontColor" value="#000000" style="margin-left: 10px;">
        </div>
    </div>

    <!-- å›¾ç‰‡æ°´å°é€‰é¡¹ -->
    <div class="options-group" id="imageWatermarkOptions" style="display: none;">
        <h4>å›¾ç‰‡æ°´å°è®¾ç½®ï¼š</h4>
        <div style="margin-bottom: 15px;">
            <label for="watermarkImage">é€‰æ‹©æ°´å°å›¾ç‰‡ï¼š</label>
            <input type="file" id="watermarkImage" accept="image/*" style="margin-left: 10px; width: 250px;">
            <div class="help-text">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œå»ºè®®å¤§å°ä¸è¶…è¿‡ 5MB</div>
        </div>
        <div style="margin-bottom: 15px;">
            <label for="imageScale">å›¾ç‰‡ç¼©æ”¾ï¼š</label>
            <input type="number" id="imageScale" value="100" min="10" max="300" step="10" style="width: 80px; margin-left: 10px;">
            <span style="margin-left: 5px; color: #6c757d;">%</span>
        </div>
    </div>

    <!-- é€šç”¨æ°´å°ä½ç½®è®¾ç½® -->
    <div class="options-group">
        <h4>æ°´å°ä½ç½®ï¼š</h4>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px; margin: 15px auto;">
            <label style="text-align: center; margin: 5px;">
                <input type="radio" name="position" value="1"> å·¦ä¸Š
            </label>
            <label style="text-align: center; margin: 5px;">
                <input type="radio" name="position" value="2"> ä¸­ä¸Š
            </label>
            <label style="text-align: center; margin: 5px;">
                <input type="radio" name="position" value="3"> å³ä¸Š
            </label>
            <label style="text-align: center; margin: 5px;">
                <input type="radio" name="position" value="4"> å·¦ä¸­
            </label>
            <label style="text-align: center; margin: 5px;">
                <input type="radio" name="position" value="5" checked> å±…ä¸­
            </label>
            <label style="text-align: center; margin: 5px;">
                <input type="radio" name="position" value="6"> å³ä¸­
            </label>
            <label style="text-align: center; margin: 5px;">
                <input type="radio" name="position" value="7"> å·¦ä¸‹
            </label>
            <label style="text-align: center; margin: 5px;">
                <input type="radio" name="position" value="8"> ä¸­ä¸‹
            </label>
            <label style="text-align: center; margin: 5px;">
                <input type="radio" name="position" value="9"> å³ä¸‹
            </label>
        </div>
    </div>

    <!-- é€æ˜åº¦è®¾ç½® -->
    <div class="options-group">
        <h4>é€æ˜åº¦è®¾ç½®ï¼š</h4>
        <div style="margin-bottom: 15px;">
            <label for="opacity">é€æ˜åº¦ï¼š</label>
            <input type="range" id="opacity" min="10" max="100" value="50" style="width: 200px; margin: 0 15px;">
            <span id="opacityValue" style="color: #6c757d;">50%</span>
        </div>
        <div class="help-text">æ•°å€¼è¶Šå°ï¼Œæ°´å°è¶Šé€æ˜</div>
    </div>

    <!-- é¡µé¢é€‰æ‹©è®¾ç½® -->
    <div class="options-group">
        <h4>é¡µé¢é€‰æ‹©ï¼š</h4>
        <label>
            <input type="radio" name="pageSelection" value="all" checked> æ‰€æœ‰é¡µé¢
        </label>
        <label>
            <input type="radio" name="pageSelection" value="range"> æŒ‡å®šé¡µé¢èŒƒå›´
        </label>
        <label>
            <input type="radio" name="pageSelection" value="specific"> æŒ‡å®šé¡µé¢
        </label>

        <div class="pages-inputs" id="pageRangeInputs">
            <div style="margin-bottom: 10px;">
                èµ·å§‹é¡µ: <input type="number" id="startPage" value="1" min="1">
                ç»“æŸé¡µ: <input type="number" id="endPage" min="1" placeholder="å¯é€‰">
            </div>
            <div class="help-text">å¦‚æœç»“æŸé¡µä¸ºç©ºï¼Œåˆ™ä»èµ·å§‹é¡µåˆ°æ–‡æ¡£æœ«å°¾</div>
        </div>

        <div class="pages-inputs" id="specificPagesInputs">
            <div style="margin-bottom: 10px;">
                <label for="specificPages">æŒ‡å®šé¡µé¢ï¼š</label>
                <input type="text" id="specificPages" placeholder="ä¾‹å¦‚: 1,3,5-8,10" style="width: 200px; margin-left: 10px;">
            </div>
            <div class="help-text">æ”¯æŒå•é¡µ(1,3)ã€èŒƒå›´(5-8)ã€æ··åˆ(1,3,5-8,10)</div>
        </div>
    </div>

    <button onclick="addWatermark()">æ·»åŠ æ°´å°</button>
</div>

<div class="progress-bar" id="watermarkProgress">
    <div class="progress-fill"></div>
</div>

<div id="watermarkResult"></div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/upload.js') }}"></script>
<script>
    // è®¾ç½®æ‹–æ”¾åŒºåŸŸ
    setupDropZone('watermarkDropZone', 'pdfFile');

    // æ°´å°ç±»å‹åˆ‡æ¢
    document.querySelectorAll('input[name="watermarkType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const textOptions = document.getElementById('textWatermarkOptions');
            const imageOptions = document.getElementById('imageWatermarkOptions');

            if (this.value === 'text') {
                textOptions.style.display = 'block';
                imageOptions.style.display = 'none';
            } else {
                textOptions.style.display = 'none';
                imageOptions.style.display = 'block';
            }
        });
    });

    // é¡µé¢é€‰æ‹©åˆ‡æ¢
    document.querySelectorAll('input[name="pageSelection"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const rangeInputs = document.getElementById('pageRangeInputs');
            const specificInputs = document.getElementById('specificPagesInputs');

            // éšè—æ‰€æœ‰è¾“å…¥æ¡†
            rangeInputs.classList.remove('show');
            specificInputs.classList.remove('show');

            // æ˜¾ç¤ºå¯¹åº”çš„è¾“å…¥æ¡†
            if (this.value === 'range') {
                rangeInputs.classList.add('show');
            } else if (this.value === 'specific') {
                specificInputs.classList.add('show');
            }
        });
    });

    // é€æ˜åº¦æ»‘å—æ›´æ–°
    document.getElementById('opacity').addEventListener('input', function() {
        document.getElementById('opacityValue').textContent = this.value + '%';
    });

    // å›¾ç‰‡å¤§å°éªŒè¯
    document.getElementById('watermarkImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MBï¼Œè¯·é€‰æ‹©æ›´å°çš„å›¾ç‰‡');
                this.value = '';
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            const fileInfo = document.createElement('div');
            fileInfo.className = 'help-text';
            fileInfo.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`;

            // ç§»é™¤ä¹‹å‰çš„æ–‡ä»¶ä¿¡æ¯
            const existingInfo = this.parentNode.querySelector('.file-info');
            if (existingInfo) {
                existingInfo.remove();
            }

            fileInfo.className += ' file-info';
            this.parentNode.appendChild(fileInfo);
        }
    });

    // æ·»åŠ æ°´å°å‡½æ•°
    async function addWatermark() {
        const pdfFile = document.getElementById('pdfFile').files[0];
        if (!pdfFile) {
            showResult('watermarkResult', 'è¯·é€‰æ‹©PDFæ–‡ä»¶', false);
            return;
        }

        const watermarkType = document.querySelector('input[name="watermarkType"]:checked').value;

        // éªŒè¯æ°´å°å†…å®¹
        if (watermarkType === 'text') {
            const watermarkText = document.getElementById('watermarkText').value.trim();
            if (!watermarkText) {
                showResult('watermarkResult', 'è¯·è¾“å…¥æ°´å°æ–‡å­—', false);
                return;
            }
        } else {
            const watermarkImage = document.getElementById('watermarkImage').files[0];
            if (!watermarkImage) {
                showResult('watermarkResult', 'è¯·é€‰æ‹©æ°´å°å›¾ç‰‡', false);
                return;
            }
        }

        // éªŒè¯é¡µé¢é€‰æ‹©
        const pageSelection = document.querySelector('input[name="pageSelection"]:checked').value;
        if (pageSelection === 'specific') {
            const specificPages = document.getElementById('specificPages').value.trim();
            if (!specificPages) {
                showResult('watermarkResult', 'è¯·è¾“å…¥è¦æ·»åŠ æ°´å°çš„é¡µé¢', false);
                return;
            }

            // ç®€å•éªŒè¯é¡µé¢æ ¼å¼
            if (!/^[\d,\-\s]+$/.test(specificPages)) {
                showResult('watermarkResult', 'é¡µé¢æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨æ•°å­—ã€é€—å·å’Œæ¨ªæ ', false);
                return;
            }
        }

        const formData = new FormData();
        formData.append('file', pdfFile);
        formData.append('watermark_type', watermarkType);

        // æ·»åŠ æ°´å°ç›¸å…³å‚æ•°
        if (watermarkType === 'text') {
            formData.append('watermark_text', document.getElementById('watermarkText').value);
            formData.append('font_size', document.getElementById('fontSize').value);
            formData.append('font_color', document.getElementById('fontColor').value);
        } else {
            formData.append('watermark_image', document.getElementById('watermarkImage').files[0]);
            formData.append('image_scale', document.getElementById('imageScale').value);
        }

        // æ·»åŠ ä½ç½®å’Œé€æ˜åº¦å‚æ•°
        formData.append('position', document.querySelector('input[name="position"]:checked').value);
        formData.append('opacity', document.getElementById('opacity').value);

        // æ·»åŠ é¡µé¢é€‰æ‹©å‚æ•°
        formData.append('page_selection', pageSelection);
        if (pageSelection === 'range') {
            const startPage = document.getElementById('startPage').value;
            const endPage = document.getElementById('endPage').value;
            formData.append('start_page', startPage);
            if (endPage) formData.append('end_page', endPage);
        } else if (pageSelection === 'specific') {
            formData.append('specific_pages', document.getElementById('specificPages').value);
        }

        showProgress('watermarkProgress');

        try {
            const response = await fetch('/api/v1/pdf/watermark', {
                method: 'POST',
                body: formData
            });

            hideProgress('watermarkProgress');

            if (response.ok) {
                const blob = await response.blob();
                const filename = `watermarked_${pdfFile.name}`;
                downloadFile(blob, filename);
                showResult('watermarkResult', 'âœ… æ°´å°æ·»åŠ æˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½', true);
            } else {
                const error = await response.json();
                showResult('watermarkResult', `âŒ é”™è¯¯: ${error.message}`, false);
            }
        } catch (error) {
            hideProgress('watermarkProgress');
            showResult('watermarkResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
        }
    }
</script>
{% endblock %}