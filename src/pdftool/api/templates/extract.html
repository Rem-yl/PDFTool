{% extends "base.html" %}

{% block title %}é¡µé¢æå– - PDFTool{% endblock %}

{% block header_icon %}ğŸ“‹{% endblock %}
{% block header_title %}é¡µé¢æå–{% endblock %}
{% block header_description %}ä»PDFæ–‡ä»¶ä¸­æå–æŒ‡å®šçš„é¡µé¢{% endblock %}

{% set show_back_button = true %}

{% block content %}
<div class="upload-area" id="extractDropZone">
    <h3>é€‰æ‹©è¦æå–é¡µé¢çš„PDFæ–‡ä»¶</h3>
    <input type="file" id="extractFile" accept=".pdf">
    
    <div class="options-group">
        <h4>é¡µé¢é€‰æ‹©ï¼š</h4>
        <p class="help-text">æ”¯æŒæ ¼å¼ï¼šå•é¡µ "3"ï¼Œå¤šé¡µ "1,3,5"ï¼ŒèŒƒå›´ "1-5" æˆ–æ··åˆ "1,3-5,8"</p>
        <label>
            é¡µé¢: <input type="text" id="pagesInput" placeholder="ä¾‹å¦‚: 1,3,5 æˆ– 1-5" required>
        </label>
        <label>
            æ–‡ä»¶åå‰ç¼€: <input type="text" id="filenamePrefix" placeholder="å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨åŸæ–‡ä»¶å">
        </label>
    </div>
    <button onclick="extractPages()">å¼€å§‹æå–</button>
</div>
<div class="progress-bar" id="extractProgress">
    <div class="progress-fill"></div>
</div>
<div id="extractResult"></div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/upload.js') }}"></script>
<script>
    // è®¾ç½®æ‹–æ”¾åŒºåŸŸ
    setupDropZone('extractDropZone', 'extractFile');

    // é¡µé¢è¾“å…¥éªŒè¯
    document.getElementById('pagesInput').addEventListener('input', function() {
        const value = this.value;
        const pattern = /^(\d+(-\d+)?)(,\s*\d+(-\d+)?)*$/;
        
        if (value && !pattern.test(value)) {
            this.setCustomValidity('è¯·è¾“å…¥æ­£ç¡®çš„é¡µé¢æ ¼å¼ï¼Œå¦‚: 1,3,5 æˆ– 1-5');
        } else {
            this.setCustomValidity('');
        }
    });

    async function extractPages() {
        const file = document.getElementById('extractFile').files[0];
        const pages = document.getElementById('pagesInput').value.trim();
        
        if (!file) {
            showResult('extractResult', 'è¯·é€‰æ‹©PDFæ–‡ä»¶', false);
            return;
        }
        
        if (!pages) {
            showResult('extractResult', 'è¯·è¾“å…¥è¦æå–çš„é¡µé¢', false);
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('pages', pages);
        
        const prefix = document.getElementById('filenamePrefix').value.trim();
        if (prefix) {
            formData.append('filename_prefix', prefix);
        }

        showProgress('extractProgress');

        try {
            const response = await fetch('/api/v1/pdf/extract', {
                method: 'POST',
                body: formData
            });
            
            hideProgress('extractProgress');
            
            if (response.ok) {
                const blob = await response.blob();
                
                // æ ¹æ®Content-Dispositionå¤´è·å–æ–‡ä»¶å
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'extracted_pages.pdf';
                if (contentDisposition) {
                    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                downloadFile(blob, filename);
                showResult('extractResult', `âœ… é¡µé¢æå–æˆåŠŸï¼å·²æå–é¡µé¢: ${pages}`, true);
            } else {
                const error = await response.json();
                showResult('extractResult', `âŒ é”™è¯¯: ${error.detail}`, false);
            }
        } catch (error) {
            hideProgress('extractProgress');
            showResult('extractResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
        }
    }
</script>
{% endblock %}