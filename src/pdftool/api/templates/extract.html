{% extends "base.html" %}

{% block title %}页面提取 - PDFTool{% endblock %}

{% block header_icon %}📋{% endblock %}
{% block header_title %}页面提取{% endblock %}
{% block header_description %}从PDF文件中提取指定的页面{% endblock %}

{% set show_back_button = true %}

{% block content %}
<div class="upload-area" id="extractDropZone">
    <h3>选择要提取页面的PDF文件</h3>
    <input type="file" id="extractFile" accept=".pdf">
    
    <div class="options-group">
        <h4>页面选择：</h4>
        <p class="help-text">支持格式：单页 "3"，多页 "1,3,5"，范围 "1-5" 或混合 "1,3-5,8"</p>
        <label>
            页面: <input type="text" id="pagesInput" placeholder="例如: 1,3,5 或 1-5" required>
        </label>
        <label>
            文件名前缀: <input type="text" id="filenamePrefix" placeholder="可选，默认使用原文件名">
        </label>
    </div>
    <button onclick="extractPages()">开始提取</button>
</div>
<div class="progress-bar" id="extractProgress">
    <div class="progress-fill"></div>
</div>
<div id="extractResult"></div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/upload.js') }}"></script>
<script>
    // 设置拖放区域
    setupDropZone('extractDropZone', 'extractFile');

    // 页面输入验证
    document.getElementById('pagesInput').addEventListener('input', function() {
        const value = this.value;
        const pattern = /^(\d+(-\d+)?)(,\s*\d+(-\d+)?)*$/;
        
        if (value && !pattern.test(value)) {
            this.setCustomValidity('请输入正确的页面格式，如: 1,3,5 或 1-5');
        } else {
            this.setCustomValidity('');
        }
    });

    async function extractPages() {
        const file = document.getElementById('extractFile').files[0];
        const pages = document.getElementById('pagesInput').value.trim();
        
        if (!file) {
            showResult('extractResult', '请选择PDF文件', false);
            return;
        }
        
        if (!pages) {
            showResult('extractResult', '请输入要提取的页面', false);
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('pages', pages);
        
        const prefix = document.getElementById('filenamePrefix').value.trim();
        if (prefix) {
            formData.append('filename_prefix', prefix);
        }

        showProgress('extractProgress');

        try {
            const response = await fetch('/api/v1/pdf/extract', {
                method: 'POST',
                body: formData
            });
            
            hideProgress('extractProgress');
            
            if (response.ok) {
                const blob = await response.blob();
                
                // 根据Content-Disposition头获取文件名
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'extracted_pages.pdf';
                if (contentDisposition) {
                    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                downloadFile(blob, filename);
                showResult('extractResult', `✅ 页面提取成功！已提取页面: ${pages}`, true);
            } else {
                const error = await response.json();
                showResult('extractResult', `❌ 错误: ${error.detail}`, false);
            }
        } catch (error) {
            hideProgress('extractProgress');
            showResult('extractResult', `❌ 请求失败: ${error.message}`, false);
        }
    }
</script>
{% endblock %}