{% extends "base.html" %}

{% block title %}é¡µé¢é€‰æ‹© - PDFTool{% endblock %}

{% block header_icon %}ğŸ“„{% endblock %}
{% block header_title %}é¡µé¢é€‰æ‹©{% endblock %}
{% block header_description %}é€‰æ‹©ã€æ‹†åˆ†ã€æå–æˆ–åˆå¹¶PDFé¡µé¢{% endblock %}

{% set show_back_button = true %}

{% block content %}
<div class="upload-area" id="pagesDropZone">
    <h3>é€‰æ‹©è¦å¤„ç†çš„PDFæ–‡ä»¶</h3>
    <input type="file" id="pagesFile" accept=".pdf">
    
    <div class="options-group">
        <h4>æ“ä½œæ¨¡å¼ï¼š</h4>
        
        <label>
            <input type="radio" name="pageMode" value="all" checked> 
            <strong>å…¨éƒ¨é¡µé¢</strong> - æ¯é¡µä¿å­˜ä¸ºå•ç‹¬æ–‡ä»¶
        </label>
        
        <label>
            <input type="radio" name="pageMode" value="pages"> 
            <strong>æŒ‡å®šé¡µé¢</strong> - æ¯é¡µä¿å­˜ä¸ºå•ç‹¬æ–‡ä»¶
        </label>
        
        <label>
            <input type="radio" name="pageMode" value="single"> 
            <strong>åˆå¹¶é€‰æ‹©</strong> - å°†æŒ‡å®šé¡µé¢åˆå¹¶ä¸ºå•ä¸ªæ–‡ä»¶
        </label>
        
        <!-- å…¨éƒ¨é¡µé¢è­¦å‘Š -->
        <div class="warning-message" id="allPagesWarning">
            <p class="warning-text">âš ï¸ <strong>æ³¨æ„ï¼š</strong>é€‰æ‹©"å…¨éƒ¨é¡µé¢"å°†æŠŠPDFçš„æ¯ä¸€é¡µéƒ½ä¿å­˜ä¸ºå•ç‹¬çš„æ–‡ä»¶ï¼Œå¯¹äºé¡µé¢è¾ƒå¤šçš„PDFæ–‡ä»¶ï¼Œæ­¤æ“ä½œå¯èƒ½æ¯”è¾ƒè€—æ—¶ã€‚</p>
        </div>

        <!-- æŒ‡å®šé¡µé¢è¾“å…¥ -->
        <div class="pages-inputs" id="pagesInputs">
            <label>
                é¡µé¢åˆ—è¡¨:
                <input type="text" id="pagesInput" placeholder="ä¾‹å¦‚: 1,3,5 æˆ– 1-5 æˆ– 1,3-5,8">
            </label>
            <p class="help-text">æ”¯æŒæ ¼å¼ï¼šå•é¡µ "3"ï¼Œå¤šé¡µ "1,3,5"ï¼ŒèŒƒå›´ "1-5" æˆ–æ··åˆ "1,3-5,8"</p>
        </div>
        
        <!-- é€šç”¨é€‰é¡¹ -->
        <div class="common-options">
            <label>
                æ–‡ä»¶åå‰ç¼€: 
                <input type="text" id="filenamePrefix" placeholder="å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨åŸæ–‡ä»¶å">
            </label>
        </div>
    </div>
    
    <button onclick="processPages()">å¼€å§‹å¤„ç†</button>
</div>

<div class="progress-bar" id="pagesProgress">
    <div class="progress-fill"></div>
</div>

<div id="pagesResult"></div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/upload.js') }}"></script>
<script>
    // è®¾ç½®æ‹–æ”¾åŒºåŸŸ
    setupDropZone('pagesDropZone', 'pagesFile');

    // åˆ‡æ¢æ“ä½œæ¨¡å¼
    document.querySelectorAll('input[name="pageMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const pagesInputs = document.getElementById('pagesInputs');
            const allPagesWarning = document.getElementById('allPagesWarning');

            // éšè—æ‰€æœ‰åŒºåŸŸ
            pagesInputs.classList.remove('show');
            allPagesWarning.classList.remove('show');

            // æ ¹æ®é€‰æ‹©æ˜¾ç¤ºå¯¹åº”åŒºåŸŸ
            if (this.value === 'all') {
                allPagesWarning.classList.add('show');
            } else if (this.value === 'pages' || this.value === 'single') {
                pagesInputs.classList.add('show');
            }
        });
    });

    // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
    document.addEventListener('DOMContentLoaded', function() {
        const checkedRadio = document.querySelector('input[name="pageMode"]:checked');
        if (checkedRadio && checkedRadio.value === 'all') {
            document.getElementById('allPagesWarning').classList.add('show');
        }
    });

    // é¡µé¢è¾“å…¥éªŒè¯
    document.getElementById('pagesInput').addEventListener('input', function() {
        const value = this.value;
        const pattern = /^(\d+(-\d+)?)(,\s*\d+(-\d+)?)*$/;
        
        if (value && !pattern.test(value)) {
            this.setCustomValidity('è¯·è¾“å…¥æ­£ç¡®çš„é¡µé¢æ ¼å¼ï¼Œå¦‚: 1,3,5 æˆ– 1-5');
        } else {
            this.setCustomValidity('');
        }
    });

    async function processPages() {
        const file = document.getElementById('pagesFile').files[0];
        const mode = document.querySelector('input[name="pageMode"]:checked').value;
        
        if (!file) {
            showResult('pagesResult', 'è¯·é€‰æ‹©PDFæ–‡ä»¶', false);
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('mode', mode);
        
        // æ ¹æ®æ¨¡å¼æ·»åŠ ç›¸åº”å‚æ•°
        if (mode === 'pages' || mode === 'single') {
            const pages = document.getElementById('pagesInput').value.trim();
            if (!pages) {
                showResult('pagesResult', 'è¯·è¾“å…¥è¦å¤„ç†çš„é¡µé¢', false);
                return;
            }
            formData.append('pages', pages);
        }
        
        // æ·»åŠ æ–‡ä»¶åå‰ç¼€
        const prefix = document.getElementById('filenamePrefix').value.trim();
        if (prefix) {
            formData.append('filename_prefix', prefix);
        }

        showProgress('pagesProgress');

        try {
            const response = await fetch('/api/v1/pdf/pages', {
                method: 'POST',
                body: formData
            });
            
            hideProgress('pagesProgress');
            
            if (response.ok) {
                const blob = await response.blob();
                
                // æ ¹æ®Content-Dispositionå¤´è·å–æ–‡ä»¶å
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'processed_pages.pdf';
                if (contentDisposition) {
                    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (matches != null && matches[1] && typeof matches[1] === 'string') {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                downloadFile(blob, filename);
                
                // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                let message = 'âœ… PDFé¡µé¢å¤„ç†æˆåŠŸï¼';
                if (mode === 'all') {
                    message += 'å·²å°†æ¯é¡µä¿å­˜ä¸ºå•ç‹¬æ–‡ä»¶';
                } else if (mode === 'pages') {
                    message += 'å·²æå–æŒ‡å®šé¡µé¢';
                } else if (mode === 'single') {
                    message += 'å·²å°†é€‰æ‹©é¡µé¢åˆå¹¶ä¸ºå•ä¸ªæ–‡ä»¶';
                }
                
                showResult('pagesResult', message, true);
            } else {
                const error = await response.json();
                showResult('pagesResult', `âŒ é”™è¯¯: ${error.detail}`, false);
            }
        } catch (error) {
            hideProgress('pagesProgress');
            showResult('pagesResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
        }
    }
</script>
{% endblock %}