{% extends "base.html" %}

{% block title %}密码保护 - PDFTool{% endblock %}

{% block header_icon %}🔒{% endblock %}
{% block header_title %}PDF密码保护{% endblock %}
{% block header_description %}为PDF文件设置密码和权限控制{% endblock %}

{% set show_back_button = true %}

{% block content %}
<div class="upload-area" id="passwordDropZone">
    <h3>选择要保护的PDF文件</h3>
    <input type="file" id="passwordFile" accept=".pdf">

    <!-- 密码设置 -->
    <div class="options-group">
        <h4>密码设置：</h4>
        <div style="margin-bottom: 15px;">
            <label for="userPassword">用户密码（必填）：</label>
            <input type="password" id="userPassword" placeholder="用于打开PDF文档" style="width: 250px; margin-left: 10px;" required>
            <div class="help-text">用户密码用于打开和查看PDF文档，长度至少4位</div>
        </div>
        <div style="margin-bottom: 15px;">
            <label for="ownerPassword">所有者密码（可选）：</label>
            <input type="password" id="ownerPassword" placeholder="用于编辑权限控制" style="width: 250px; margin-left: 10px;">
            <div class="help-text">所有者密码用于控制编辑权限，留空则使用用户密码</div>
        </div>
    </div>

    <!-- 权限控制 -->
    <div class="options-group">
        <h4>权限设置：</h4>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0;">
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowPrinting" checked style="margin-right: 8px;">
                允许打印
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowCopying" checked style="margin-right: 8px;">
                允许复制文本
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowModification" checked style="margin-right: 8px;">
                允许修改内容
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowAnnotation" checked style="margin-right: 8px;">
                允许添加注释
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowFillingForms" checked style="margin-right: 8px;">
                允许填写表单
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowScreenReaders" checked style="margin-right: 8px;">
                允许屏幕阅读器访问
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowAssembly" checked style="margin-right: 8px;">
                允许文档组装
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowDegradedPrinting" checked style="margin-right: 8px;">
                允许低质量打印
            </label>
        </div>
    </div>

    <button onclick="protectPDF()">🔒 设置密码保护</button>
</div>

<div class="progress-bar" id="passwordProgress">
    <div class="progress-fill"></div>
</div>

<div id="passwordResult"></div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/upload.js') }}"></script>
<script>
    // 设置拖放区域
    setupDropZone('passwordDropZone', 'passwordFile');

    async function protectPDF() {
        const file = document.getElementById('passwordFile').files[0];
        const userPassword = document.getElementById('userPassword').value.trim();

        if (!file) {
            showResult('passwordResult', '❌ 请选择PDF文件！', false);
            return;
        }

        if (!userPassword) {
            showResult('passwordResult', '❌ 请输入用户密码！', false);
            return;
        }

        if (userPassword.length < 4) {
            showResult('passwordResult', '❌ 密码长度至少为4位！', false);
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('user_password', userPassword);

        const ownerPassword = document.getElementById('ownerPassword').value.trim();
        if (ownerPassword) {
            formData.append('owner_password', ownerPassword);
        }

        // 添加权限设置
        formData.append('allow_printing', document.getElementById('allowPrinting').checked);
        formData.append('allow_copying', document.getElementById('allowCopying').checked);
        formData.append('allow_modification', document.getElementById('allowModification').checked);
        formData.append('allow_annotation', document.getElementById('allowAnnotation').checked);
        formData.append('allow_filling_forms', document.getElementById('allowFillingForms').checked);
        formData.append('allow_screen_readers', document.getElementById('allowScreenReaders').checked);
        formData.append('allow_assembly', document.getElementById('allowAssembly').checked);
        formData.append('allow_degraded_printing', document.getElementById('allowDegradedPrinting').checked);

        showProgress('passwordProgress');

        try {
            const response = await fetch('/api/v1/pdf/password', {
                method: 'POST',
                body: formData
            });

            hideProgress('passwordProgress');

            if (response.ok) {
                const blob = await response.blob();
                // 生成下载文件名：原文件名_protected.pdf
                const originalName = file.name;
                const nameWithoutExt = originalName.replace(/\.pdf$/i, '');
                const downloadName = `${nameWithoutExt}_protected.pdf`;

                downloadFile(blob, downloadName);
                showResult('passwordResult', '✅ PDF密码保护设置成功！文件已自动下载', true);
            } else {
                const error = await response.json();
                showResult('passwordResult', `❌ 错误: ${error.detail || '密码保护失败'}`, false);
            }
        } catch (error) {
            hideProgress('passwordProgress');
            showResult('passwordResult', `❌ 请求失败: ${error.message}`, false);
        }
    }
</script>
{% endblock %}