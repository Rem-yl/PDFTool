{% extends "base.html" %}

{% block title %}å¯†ç ä¿æŠ¤ - PDFTool{% endblock %}

{% block header_icon %}ğŸ”’{% endblock %}
{% block header_title %}PDFå¯†ç ä¿æŠ¤{% endblock %}
{% block header_description %}ä¸ºPDFæ–‡ä»¶è®¾ç½®å¯†ç å’Œæƒé™æ§åˆ¶{% endblock %}

{% set show_back_button = true %}

{% block content %}
<div class="upload-area" id="passwordDropZone">
    <h3>é€‰æ‹©è¦ä¿æŠ¤çš„PDFæ–‡ä»¶</h3>
    <input type="file" id="passwordFile" accept=".pdf">

    <!-- å¯†ç è®¾ç½® -->
    <div class="options-group">
        <h4>å¯†ç è®¾ç½®ï¼š</h4>
        <div style="margin-bottom: 15px;">
            <label for="userPassword">ç”¨æˆ·å¯†ç ï¼ˆå¿…å¡«ï¼‰ï¼š</label>
            <input type="password" id="userPassword" placeholder="ç”¨äºæ‰“å¼€PDFæ–‡æ¡£" style="width: 250px; margin-left: 10px;" required>
            <div class="help-text">ç”¨æˆ·å¯†ç ç”¨äºæ‰“å¼€å’ŒæŸ¥çœ‹PDFæ–‡æ¡£ï¼Œé•¿åº¦è‡³å°‘4ä½</div>
        </div>
        <div style="margin-bottom: 15px;">
            <label for="ownerPassword">æ‰€æœ‰è€…å¯†ç ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="password" id="ownerPassword" placeholder="ç”¨äºç¼–è¾‘æƒé™æ§åˆ¶" style="width: 250px; margin-left: 10px;">
            <div class="help-text">æ‰€æœ‰è€…å¯†ç ç”¨äºæ§åˆ¶ç¼–è¾‘æƒé™ï¼Œç•™ç©ºåˆ™ä½¿ç”¨ç”¨æˆ·å¯†ç </div>
        </div>
    </div>

    <!-- æƒé™æ§åˆ¶ -->
    <div class="options-group">
        <h4>æƒé™è®¾ç½®ï¼š</h4>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0;">
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowPrinting" checked style="margin-right: 8px;">
                å…è®¸æ‰“å°
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowCopying" checked style="margin-right: 8px;">
                å…è®¸å¤åˆ¶æ–‡æœ¬
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowModification" checked style="margin-right: 8px;">
                å…è®¸ä¿®æ”¹å†…å®¹
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowAnnotation" checked style="margin-right: 8px;">
                å…è®¸æ·»åŠ æ³¨é‡Š
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowFillingForms" checked style="margin-right: 8px;">
                å…è®¸å¡«å†™è¡¨å•
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowScreenReaders" checked style="margin-right: 8px;">
                å…è®¸å±å¹•é˜…è¯»å™¨è®¿é—®
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowAssembly" checked style="margin-right: 8px;">
                å…è®¸æ–‡æ¡£ç»„è£…
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="allowDegradedPrinting" checked style="margin-right: 8px;">
                å…è®¸ä½è´¨é‡æ‰“å°
            </label>
        </div>
    </div>

    <button onclick="protectPDF()">ğŸ”’ è®¾ç½®å¯†ç ä¿æŠ¤</button>
</div>

<div class="progress-bar" id="passwordProgress">
    <div class="progress-fill"></div>
</div>

<div id="passwordResult"></div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/upload.js') }}"></script>
<script>
    // è®¾ç½®æ‹–æ”¾åŒºåŸŸ
    setupDropZone('passwordDropZone', 'passwordFile');

    async function protectPDF() {
        const file = document.getElementById('passwordFile').files[0];
        const userPassword = document.getElementById('userPassword').value.trim();

        if (!file) {
            showResult('passwordResult', 'âŒ è¯·é€‰æ‹©PDFæ–‡ä»¶ï¼', false);
            return;
        }

        if (!userPassword) {
            showResult('passwordResult', 'âŒ è¯·è¾“å…¥ç”¨æˆ·å¯†ç ï¼', false);
            return;
        }

        if (userPassword.length < 4) {
            showResult('passwordResult', 'âŒ å¯†ç é•¿åº¦è‡³å°‘ä¸º4ä½ï¼', false);
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('user_password', userPassword);

        const ownerPassword = document.getElementById('ownerPassword').value.trim();
        if (ownerPassword) {
            formData.append('owner_password', ownerPassword);
        }

        // æ·»åŠ æƒé™è®¾ç½®
        formData.append('allow_printing', document.getElementById('allowPrinting').checked);
        formData.append('allow_copying', document.getElementById('allowCopying').checked);
        formData.append('allow_modification', document.getElementById('allowModification').checked);
        formData.append('allow_annotation', document.getElementById('allowAnnotation').checked);
        formData.append('allow_filling_forms', document.getElementById('allowFillingForms').checked);
        formData.append('allow_screen_readers', document.getElementById('allowScreenReaders').checked);
        formData.append('allow_assembly', document.getElementById('allowAssembly').checked);
        formData.append('allow_degraded_printing', document.getElementById('allowDegradedPrinting').checked);

        showProgress('passwordProgress');

        try {
            const response = await fetch('/api/v1/pdf/password', {
                method: 'POST',
                body: formData
            });

            hideProgress('passwordProgress');

            if (response.ok) {
                const blob = await response.blob();
                // ç”Ÿæˆä¸‹è½½æ–‡ä»¶åï¼šåŸæ–‡ä»¶å_protected.pdf
                const originalName = file.name;
                const nameWithoutExt = originalName.replace(/\.pdf$/i, '');
                const downloadName = `${nameWithoutExt}_protected.pdf`;

                downloadFile(blob, downloadName);
                showResult('passwordResult', 'âœ… PDFå¯†ç ä¿æŠ¤è®¾ç½®æˆåŠŸï¼æ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½', true);
            } else {
                const error = await response.json();
                showResult('passwordResult', `âŒ é”™è¯¯: ${error.detail || 'å¯†ç ä¿æŠ¤å¤±è´¥'}`, false);
            }
        } catch (error) {
            hideProgress('passwordProgress');
            showResult('passwordResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
        }
    }
</script>
{% endblock %}