{% extends "base.html" %}

{% block title %}PDFåˆå¹¶ - PDFTool{% endblock %}

{% block header_icon %}ğŸ“„{% endblock %}
{% block header_title %}PDFåˆå¹¶{% endblock %}
{% block header_description %}å°†å¤šä¸ªPDFæ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªæ–‡ä»¶{% endblock %}

{% set show_back_button = true %}

{% block content %}
<div class="upload-area" id="mergeDropZone">
    <h3>é€‰æ‹©è¦åˆå¹¶çš„PDFæ–‡ä»¶</h3>
    <p>è¯·é€‰æ‹©è‡³å°‘2ä¸ªPDFæ–‡ä»¶è¿›è¡Œåˆå¹¶</p>
    <input type="file" id="mergeFiles" multiple accept=".pdf">
    <br>
    <div class="options-group">
        <label>
            <input type="checkbox" id="preserveBookmarks" checked> ä¿ç•™ä¹¦ç­¾
        </label>
        <label>
            <input type="checkbox" id="preserveMetadata" checked> ä¿ç•™å…ƒæ•°æ®
        </label>
    </div>
    <button onclick="mergePDFs()">å¼€å§‹åˆå¹¶</button>
</div>
<div class="progress-bar" id="mergeProgress">
    <div class="progress-fill"></div>
</div>
<div id="mergeResult"></div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='/js/upload.js') }}"></script>
<script>
    // è®¾ç½®æ‹–æ”¾åŒºåŸŸ
    setupDropZone('mergeDropZone', 'mergeFiles');

    async function mergePDFs() {
        const files = document.getElementById('mergeFiles').files;
        if (files.length < 2) {
            showResult('mergeResult', 'è¯·é€‰æ‹©è‡³å°‘2ä¸ªPDFæ–‡ä»¶', false);
            return;
        }

        const formData = new FormData();
        for (let file of files) {
            formData.append('files', file);
        }
        
        // æ·»åŠ é€‰é¡¹
        formData.append('preserve_bookmarks', document.getElementById('preserveBookmarks').checked);
        formData.append('preserve_metadata', document.getElementById('preserveMetadata').checked);

        showProgress('mergeProgress');
        
        try {
            const response = await fetch('/api/v1/pdf/merge', {
                method: 'POST',
                body: formData
            });
            
            hideProgress('mergeProgress');
            
            if (response.ok) {
                const blob = await response.blob();
                downloadFile(blob, 'merged.pdf');
                showResult('mergeResult', `âœ… PDFåˆå¹¶æˆåŠŸï¼å·²åˆå¹¶ ${files.length} ä¸ªæ–‡ä»¶`, true);
            } else {
                const error = await response.json();
                showResult('mergeResult', `âŒ é”™è¯¯: ${error.message}`, false);
            }
        } catch (error) {
            hideProgress('mergeProgress');
            showResult('mergeResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
        }
    }
</script>
{% endblock %}